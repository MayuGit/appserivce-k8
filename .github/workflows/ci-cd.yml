name: CI/CD Pipeline

on:
  push:
    branches:
      - master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
      DOCKER_HUB_ACCESS_TOKEN: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up JDK 11
      uses: actions/setup-java@v2
      with:
        java-version: '11'

    - name: Build with Maven
      run: mvn clean package

    - name: Log in to Docker Hub
      run: echo $DOCKER_HUB_ACCESS_TOKEN | docker login -u $DOCKER_HUB_USERNAME --password-stdin

    - name: Build Docker image for Service A
      run: docker build -t $DOCKER_HUB_USERNAME/service-a:latest ./service-a

    - name: Push Docker image for Service A
      run: docker push $DOCKER_HUB_USERNAME/service-a:latest

    - name: Build Docker image for Service B
      run: docker build -t $DOCKER_HUB_USERNAME/service-b:latest ./service-b

    - name: Push Docker image for Service B
      run: docker push $DOCKER_HUB_USERNAME/service-b:latest

    - name: Set up kubectl
      run: |
        echo "$KUBE_CONFIG_DATA" | base64 --decode > $HOME/.kube/config
        kubectl config set-context --current --namespace=myapp1

    - name: Deploy to Kubernetes
      run: |
        kubectl apply -f k8s/service-a-deployment.yaml
        kubectl apply -f k8s/service-b-deployment.yaml
